{% macro render_editor(field_edit, syntax) %}
<style>
    .ace-editor-container {
        width: 100%;
        min-height: 300px;
        border: 1px solid #ccc;
        border-top: none;
        resize: vertical;
        overflow: hidden;
        border-radius: 0 0 4px 4px;
        background-color: #fff;
    }
    
    /* Стили для светлой темы Bootstrap */
    [data-bs-theme="light"] .ace-editor-container {
        border-color: #ccc;
    }
    
    /* Стили для темной темы Bootstrap */
    [data-bs-theme="dark"] .ace-editor-container {
        border-color: #495057;
        background-color: #0f1115;
    }
    
    /* Расширенный выпадающий список автодополнения */
    .ace_autocomplete {
        width: 650px !important;
        max-width: 90% !important;
        font-family: 'Segoe UI', system-ui, sans-serif !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        border: 1px solid #ccc !important;
        border-radius: 4px !important;
    }
    
    /* Стили автодополнения для темной темы */
    [data-bs-theme="dark"] .ace_autocomplete {
        background-color: #212529 !important;
        border-color: #495057 !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }
    
    [data-bs-theme="dark"] .ace_autocomplete .ace_completion_item {
        background-color: #212529 !important;
        color: #f8f9fa !important;
    }
    
    [data-bs-theme="dark"] .ace_autocomplete .ace_completion_item.ace_selected {
        background-color: #495057 !important;
    }
    
    [data-bs-theme="dark"] .ace_autocomplete .ace_rightAlignedText {
        color: #adb5bd !important;
    }

    .ace_autocomplete .ace_completion_item {
        padding: 6px 10px !important;
        font-size: 13px !important;
    }

    .ace_autocomplete .ace_rightAlignedText {
        color: #666 !important;
        font-size: 12px !important;
        min-width: 120px !important;
        text-align: right !important;
    }
    
    /* Стили для тулбара редактора */
    .ace-editor-wrapper {
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 1rem;
        background-color: #fff;
    }
    
    [data-bs-theme="dark"] .ace-editor-wrapper {
        background-color: #1b1f24;
    }
    
    .ace-editor-toolbar {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 8px 12px;
        background-color: #f8f9fa;
        border: 1px solid #ccc;
        border-bottom: none;
        border-radius: 4px 4px 0 0;
        flex-wrap: wrap;
        justify-content: space-between;
        row-gap: 12px;
    }
    
    .ace-editor-toolbar .toolbar-left,
    .ace-editor-toolbar .toolbar-right {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .ace-editor-toolbar .toolbar-right {
        margin-left: auto;
    }
    
    [data-bs-theme="dark"] .ace-editor-toolbar {
        background-color: #212529;
        border-color: #495057;
    }
    
    .ace-editor-toolbar label {
        margin: 0;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        color: #212529;
    }
    
    [data-bs-theme="dark"] .ace-editor-toolbar label {
        color: #f8f9fa;
    }
    
    .ace-editor-toolbar select {
        font-size: 13px;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: #fff;
        min-width: 140px;
    }
    
    [data-bs-theme="dark"] .ace-editor-toolbar select {
        background-color: #343a40;
        border-color: #495057;
        color: #f8f9fa;
    }
    
    .ace-editor-toolbar .theme-selector {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .ace-editor-toolbar .theme-selector[data-theme="dark"] {
        display: none;
    }
    
    [data-bs-theme="dark"] .ace-editor-toolbar .theme-selector[data-theme="light"] {
        display: none;
    }
    
    [data-bs-theme="dark"] .ace-editor-toolbar .theme-selector[data-theme="dark"] {
        display: flex;
    }
    
    .ace-editor-toolbar .divider {
        width: 1px;
        height: 24px;
        background-color: #dee2e6;
        margin: 0 4px;
    }
    
    [data-bs-theme="dark"] .ace-editor-toolbar .divider {
        background-color: #495057;
    }
    
    [data-bs-theme="dark"] .ace-editor-toolbar .theme-divider {
        display: none;
    }
    
    .ace-editor-toolbar .btn {
        padding: 4px 8px;
        font-size: 13px;
    }
    
    .ace-editor-toolbar .btn i {
        pointer-events: none;
    }
    
    .ace-editor-toolbar .btn.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }
    
    .ace-editor-toolbar .btn-group + .btn-group {
        margin-left: 6px;
    }
    
    .ace-editor-wrapper.fullscreen {
        position: fixed;
        inset: 0;
        z-index: 1060;
        background-color: #0f1115;
        padding: 12px;
        display: flex;
        flex-direction: column;
    }
    
    .ace-editor-wrapper.fullscreen .ace-editor-toolbar {
        border-radius: 6px;
        margin-bottom: 10px;
    }
    
    .ace-editor-wrapper.fullscreen .ace-editor-container {
        flex: 1;
        min-height: 0;
        border-radius: 6px;
    }
    
    body.ace-editor-lock-scroll {
        overflow: hidden;
    }
    
    @media (max-width: 768px) {
        .ace-editor-toolbar {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .ace-editor-toolbar .divider {
            display: none;
        }
        
        .ace-editor-toolbar .theme-selector {
            width: 100%;
        }
        
        .ace-editor-toolbar select {
            flex: 1;
            min-width: auto;
        }
        
        .ace-editor-toolbar .toolbar-right {
            width: 100%;
            justify-content: flex-start;
        }
    }
</style>

<script>
    if (typeof ace !== 'undefined') {
        ace.config.set("useWorker", false);
    }
</script>

<script src="{{ config.ASSETS_ROOT }}/plugins/ace/ace.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/ace/ext-language_tools.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/ace/mode-json.js"></script>
<!-- Загрузка популярных тем ACE Editor -->
<script src="{{ config.ASSETS_ROOT }}/plugins/ace/theme-chrome.js"></script>
<script src="{{ config.ASSETS_ROOT }}/plugins/ace/theme-monokai.js"></script>
<script>
    // Динамическая загрузка дополнительных тем ACE (если доступны)
    (function() {
        var lightThemes = ['github', 'xcode', 'textmate', 'solarized_light', 'tomorrow', 'eclipse', 'clouds'];
        var darkThemes = ['tomorrow_night', 'dracula', 'twilight', 'solarized_dark', 'vibrant_ink', 'merbivore', 'pastel_on_dark'];
        
        function loadTheme(themeName) {
            var script = document.createElement('script');
            script.src = "{{ config.ASSETS_ROOT }}/plugins/ace/theme-" + themeName + ".js";
            script.onerror = function() {
                // Тема недоступна, игнорируем
            };
            document.head.appendChild(script);
        }
        
        // Загружаем темы асинхронно
        lightThemes.forEach(loadTheme);
        darkThemes.forEach(loadTheme);
    })();
</script>

<textarea name="{{ field_edit.name }}" id="{{ field_edit.name }}" style="display:none;">{{ field_edit.data or '' }}</textarea>
<div id="ace-wrapper-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" class="ace-editor-wrapper">
    <div class="ace-editor-toolbar">

        <div class="toolbar-left">
            <div class="btn-group btn-group-sm" role="group" aria-label="{{ gettext('Editing actions') }}">
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-undo-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Undo (Ctrl+Z)') }}">
                    <i class="fa-solid fa-rotate-left"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-redo-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Redo (Ctrl+Shift+Z)') }}">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-copy-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Copy entire code') }}">
                    <i class="fa-solid fa-copy"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-find-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Find/replace (Ctrl+F)') }}">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-save-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Save template') }}">
                    <i class="fa-solid fa-floppy-disk"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-help-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Documentation') }}">
                    <i class="fa-solid fa-circle-question"></i>
                </button>
                {% if syntax == 'python' %}
                <button type="button" class="btn btn-outline-success" id="ace-btn-validate-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Validate syntax') }}">
                    <i class="fa-solid fa-check-double"></i>
                </button>
                {% endif %}
            </div>
            <div class="btn-group btn-group-sm" role="group" aria-label="{{ gettext('View options') }}">
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-wrap-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Toggle line wrap') }}">
                    <i class="fa-solid fa-align-left"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-gutter-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Toggle line numbers') }}">
                    <i class="fa-solid fa-list-ol"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-invisibles-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Toggle invisibles') }}">
                    <i class="fa-solid fa-paragraph"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-margin-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Toggle print margin') }}">
                    <i class="fa-solid fa-ruler-vertical"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="ace-btn-fullscreen-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" title="{{ gettext('Fullscreen mode') }}">
                    <i class="fa-solid fa-expand"></i>
                </button>
            </div>
        </div>
        <div class="toolbar-right">
            <div class="theme-selector" data-theme="light">
                <label for="ace-theme-light-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}">{{ gettext('Light theme:') }}</label>
                <select id="ace-theme-light-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" class="form-select form-select-sm" style="width: auto;">
                    <option value="chrome">Chrome</option>
                    <option value="github">GitHub</option>
                    <option value="xcode">Xcode</option>
                    <option value="textmate">TextMate</option>
                    <option value="solarized_light">Solarized Light</option>
                    <option value="tomorrow">Tomorrow</option>
                    <option value="eclipse">Eclipse</option>
                    <option value="clouds">Clouds</option>
                </select>
            </div>
            <div class="theme-selector" data-theme="dark">
                <label for="ace-theme-dark-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}">{{ gettext('Dark theme:') }}</label>
                <select id="ace-theme-dark-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" class="form-select form-select-sm" style="width: auto;">
                    <option value="monokai">Monokai</option>
                    <option value="tomorrow_night">Tomorrow Night</option>
                    <option value="dracula">Dracula</option>
                    <option value="twilight">Twilight</option>
                    <option value="solarized_dark">Solarized Dark</option>
                    <option value="vibrant_ink">Vibrant Ink</option>
                    <option value="merbivore">Merbivore</option>
                    <option value="pastel_on_dark">Pastel on Dark</option>
                </select>
            </div>
        </div>
    </div>
    <div id="editor-{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}" class="ace-editor-container">{{ field_edit.data or '' }}</div>
</div>

<script>
(function() {
    var editorKey = "{{ field_edit.name|replace('.', '_')|replace('[', '_')|replace(']', '_') }}";
    var editorId = "editor-" + editorKey;
    var wrapperId = "ace-wrapper-" + editorKey;
    var themeLightId = "ace-theme-light-" + editorKey;
    var themeDarkId = "ace-theme-dark-" + editorKey;
    var editorHelpUrl = {{ config.get('CODE_EDITOR_HELP_URL', '/docs')|tojson }};
    
    var editorWrapper = document.getElementById(wrapperId);
    var hiddenField = document.getElementById('{{ field_edit.name }}');
    var editorElement = document.getElementById(editorId);
    var formElement = editorElement ? editorElement.closest('form') : null;
    
    // === Функция для определения текущей темы Bootstrap ===
    function getBootstrapTheme() {
        var bodyTag = document.querySelector('[data-tag="body"]') || document.body;
        return bodyTag.getAttribute('data-bs-theme') || 'light';
    }
    
    // === Функции для работы с localStorage ===
    function getStoredTheme(themeType) {
        var key = 'ace-editor-theme-' + themeType + '-' + editorId;
        return localStorage.getItem(key);
    }
    
    function setStoredTheme(themeType, themeName) {
        var key = 'ace-editor-theme-' + themeType + '-' + editorId;
        localStorage.setItem(key, themeName);
    }
    
    function getPreferenceKey(name) {
        return 'ace-editor-pref-' + editorKey + '-' + name;
    }
    
    function getStoredPreference(name, defaultValue) {
        var stored = localStorage.getItem(getPreferenceKey(name));
        if (stored === null) {
            return defaultValue;
        }
        if (stored === 'true' || stored === 'false') {
            return stored === 'true';
        }
        return stored;
    }
    
    function setStoredPreference(name, value) {
        var normalized = typeof value === 'boolean' ? (value ? 'true' : 'false') : value;
        localStorage.setItem(getPreferenceKey(name), normalized);
    }
    
    // === Функция для получения темы ACE Editor на основе темы Bootstrap ===
    function getAceTheme(bootstrapTheme) {
        var storedTheme = getStoredTheme(bootstrapTheme);
        if (storedTheme) {
            return 'ace/theme/' + storedTheme;
        }
        // Значения по умолчанию
        if (bootstrapTheme === 'dark') {
            return 'ace/theme/monokai';
        }
        return 'ace/theme/chrome';
    }
    
    // === Функция для загрузки темы ACE (с fallback) ===
    function loadAceTheme(themeName, callback) {
        var themePath = 'ace/theme/' + themeName;
        var currentTheme = getBootstrapTheme();
        try {
            if (typeof ace !== 'undefined' && ace.require) {
                ace.require(themePath);
                if (callback) callback(themePath);
            } else {
                // Пробуем загрузить скрипт темы
                var script = document.createElement('script');
                script.src = "{{ config.ASSETS_ROOT }}/plugins/ace/theme-" + themeName + ".js";
                script.onload = function() {
                    if (callback) callback(themePath);
                };
                script.onerror = function() {
                    // Fallback на доступные темы
                    var fallback = currentTheme === 'dark' ? 'monokai' : 'chrome';
                    if (callback) callback('ace/theme/' + fallback);
                };
                document.head.appendChild(script);
            }
        } catch(e) {
            // Fallback на доступные темы
            var fallback = currentTheme === 'dark' ? 'monokai' : 'chrome';
            if (callback) callback('ace/theme/' + fallback);
        }
    }
    
    // === Инициализация редактора ===
    var currentBootstrapTheme = getBootstrapTheme();
    var DEFAULT_MIN_LINES = 5;
    var DEFAULT_MAX_LINES = 40;
    function computeFullscreenLines() {
        var toolbar = editorWrapper ? editorWrapper.querySelector('.ace-editor-toolbar') : null;
        var toolbarHeight = toolbar ? toolbar.offsetHeight : 0;
        var wrapperStyles = editorWrapper ? window.getComputedStyle(editorWrapper) : null;
        var paddingTop = wrapperStyles ? parseFloat(wrapperStyles.paddingTop || 0) : 0;
        var paddingBottom = wrapperStyles ? parseFloat(wrapperStyles.paddingBottom || 0) : 0;
        var availableHeight = window.innerHeight - toolbarHeight - paddingTop - paddingBottom - 10;
        if (availableHeight < 200) {
            availableHeight = 200;
        }
        var lineHeight = editor.renderer.lineHeight || 16;
        return Math.max(Math.floor(availableHeight / lineHeight), DEFAULT_MIN_LINES);
    }
    
    var editor = ace.edit(editorId, {
        theme: getAceTheme(currentBootstrapTheme),
        mode: "ace/mode/{{ syntax }}",
        autoScrollEditorIntoView: true,
        maxLines: DEFAULT_MAX_LINES,
        minLines: DEFAULT_MIN_LINES,
        fontSize: 16,
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true,
        showPrintMargin: false,
        useWorker: true
    });
    
    var displaySettings = {
        wrap: !!getStoredPreference('wrap', editor.session.getUseWrapMode()),
        gutter: !!getStoredPreference('gutter', editor.renderer.getShowGutter()),
        invisibles: !!getStoredPreference('invisibles', editor.getShowInvisibles()),
        margin: !!getStoredPreference('margin', editor.getShowPrintMargin())
    };
    
    editor.session.setUseWrapMode(displaySettings.wrap);
    editor.renderer.setShowGutter(displaySettings.gutter);
    editor.setShowInvisibles(displaySettings.invisibles);
    editor.setShowPrintMargin(displaySettings.margin);
    
    var toolbarButtons = {
        undo: document.getElementById("ace-btn-undo-" + editorKey),
        redo: document.getElementById("ace-btn-redo-" + editorKey),
        copy: document.getElementById("ace-btn-copy-" + editorKey),
        find: document.getElementById("ace-btn-find-" + editorKey),
        save: document.getElementById("ace-btn-save-" + editorKey),
        help: document.getElementById("ace-btn-help-" + editorKey),
        validate: document.getElementById("ace-btn-validate-" + editorKey),
        wrap: document.getElementById("ace-btn-wrap-" + editorKey),
        gutter: document.getElementById("ace-btn-gutter-" + editorKey),
        invisibles: document.getElementById("ace-btn-invisibles-" + editorKey),
        margin: document.getElementById("ace-btn-margin-" + editorKey),
        fullscreen: document.getElementById("ace-btn-fullscreen-" + editorKey)
    };
    
    function bindButton(button, handler) {
        if (!button) return;
        button.addEventListener('click', function(event) {
            event.preventDefault();
            handler();
        });
    }
    
    function setButtonActive(button, isActive) {
        if (!button) return;
        button.classList.toggle('active', !!isActive);
    }
    
    function syncEditorValue() {
        if (hiddenField) {
            hiddenField.value = editor.getValue();
        }
    }
    
    function copyAllCode() {
        var code = editor.getValue();
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(code).catch(function(err) {
                console.warn("Clipboard write failed", err);
            });
        } else {
            var temp = document.createElement('textarea');
            temp.value = code;
            document.body.appendChild(temp);
            temp.select();
            try { document.execCommand('copy'); } catch(e) { console.warn("Copy failed", e); }
            document.body.removeChild(temp);
        }
    }
    
    function toggleWrap() {
        var next = !editor.session.getUseWrapMode();
        editor.session.setUseWrapMode(next);
        setButtonActive(toolbarButtons.wrap, next);
        editor.resize();
        setStoredPreference('wrap', next);
    }
    
    function toggleGutter() {
        var next = !editor.renderer.getShowGutter();
        editor.renderer.setShowGutter(next);
        setButtonActive(toolbarButtons.gutter, next);
        editor.resize();
        setStoredPreference('gutter', next);
    }
    
    function toggleInvisibles() {
        var next = !editor.getShowInvisibles();
        editor.setShowInvisibles(next);
        setButtonActive(toolbarButtons.invisibles, next);
        setStoredPreference('invisibles', next);
    }
    
    function toggleMargin() {
        var next = !editor.getShowPrintMargin();
        editor.setShowPrintMargin(next);
        setButtonActive(toolbarButtons.margin, next);
        setStoredPreference('margin', next);
    }
    
    var isFullscreen = false;
    function toggleFullscreen(forceState) {
        if (!editorWrapper) return;
        var nextState = (typeof forceState === 'boolean') ? forceState : !isFullscreen;
        isFullscreen = nextState;
        editorWrapper.classList.toggle('fullscreen', nextState);
        document.body.classList.toggle('ace-editor-lock-scroll', nextState);
        setButtonActive(toolbarButtons.fullscreen, nextState);
        if (toolbarButtons.fullscreen) {
            var icon = toolbarButtons.fullscreen.querySelector('i');
            if (icon) {
                icon.classList.toggle('fa-expand', !nextState);
                icon.classList.toggle('fa-compress', nextState);
            }
        }
        if (nextState) {
            var fullscreenLines = computeFullscreenLines();
            editor.setOption('maxLines', fullscreenLines);
            editor.setOption('minLines', fullscreenLines);
            editorElement.style.height = '';
        } else {
            editor.setOption('maxLines', DEFAULT_MAX_LINES);
            editor.setOption('minLines', DEFAULT_MIN_LINES);
        }
        editor.resize(true);
    }
    
    window.addEventListener('resize', function() {
        if (isFullscreen) {
            var fullscreenLines = computeFullscreenLines();
            editor.setOption('maxLines', fullscreenLines);
            editor.setOption('minLines', fullscreenLines);
            editor.resize(true);
        }
    });
    
    document.addEventListener('keydown', function(evt) {
        if (isFullscreen && evt.key === 'Escape') {
            toggleFullscreen(false);
        }
    });
    
    function performSave() {
        syncEditorValue();
        if (formElement) {
            if (typeof formElement.requestSubmit === 'function') {
                formElement.requestSubmit();
            } else {
                formElement.submit();
            }
        }
    }
    
    bindButton(toolbarButtons.undo, function() { editor.undo(); });
    bindButton(toolbarButtons.redo, function() { editor.redo(); });
    bindButton(toolbarButtons.copy, function() { copyAllCode(); });
    bindButton(toolbarButtons.find, function() { editor.execCommand("find"); editor.focus(); });
    bindButton(toolbarButtons.save, performSave);
    bindButton(toolbarButtons.help, function() { window.open(editorHelpUrl, '_blank', 'noopener'); });
    bindButton(toolbarButtons.wrap, toggleWrap);
    bindButton(toolbarButtons.gutter, toggleGutter);
    bindButton(toolbarButtons.invisibles, toggleInvisibles);
    bindButton(toolbarButtons.margin, toggleMargin);
    bindButton(toolbarButtons.fullscreen, function() { toggleFullscreen(); });
    
    setButtonActive(toolbarButtons.wrap, editor.session.getUseWrapMode());
    setButtonActive(toolbarButtons.gutter, editor.renderer.getShowGutter());
    setButtonActive(toolbarButtons.invisibles, editor.getShowInvisibles());
    setButtonActive(toolbarButtons.margin, editor.getShowPrintMargin());
    setButtonActive(toolbarButtons.fullscreen, false);
    
    editor.commands.addCommand({
        name: "saveTemplateCommand",
        bindKey: { win: "Ctrl-S", mac: "Command-S" },
        exec: function() {
            performSave();
        }
    });
    
    document.addEventListener('keydown', function(evt) {
        if ((evt.ctrlKey || evt.metaKey) && evt.key && evt.key.toLowerCase() === 's') {
            evt.preventDefault();
            performSave();
        }
    }, true);
    
    // === Инициализация селектов тем ===
    var themeLightSelect = document.getElementById(themeLightId);
    var themeDarkSelect = document.getElementById(themeDarkId);
    
    // Загружаем сохраненные темы в селекты
    var storedLightTheme = getStoredTheme('light') || 'chrome';
    var storedDarkTheme = getStoredTheme('dark') || 'monokai';
    
    if (themeLightSelect) {
        themeLightSelect.value = storedLightTheme;
        themeLightSelect.addEventListener('change', function() {
            var selectedTheme = this.value;
            setStoredTheme('light', selectedTheme);
            if (currentBootstrapTheme === 'light') {
                applyTheme('ace/theme/' + selectedTheme);
            }
        });
    }
    
    if (themeDarkSelect) {
        themeDarkSelect.value = storedDarkTheme;
        themeDarkSelect.addEventListener('change', function() {
            var selectedTheme = this.value;
            setStoredTheme('dark', selectedTheme);
            if (currentBootstrapTheme === 'dark') {
                applyTheme('ace/theme/' + selectedTheme);
            }
        });
    }
    
    // === Функция применения темы ===
    function applyTheme(themePath) {
        try {
            editor.setTheme(themePath);
            removeDarkThemeStyles();
        } catch(e) {
            // Если тема не загружена, пробуем загрузить
            var themeName = themePath.replace('ace/theme/', '');
            loadAceTheme(themeName, function(loadedTheme) {
                try {
                    editor.setTheme(loadedTheme);
                    removeDarkThemeStyles();
                } catch(e2) {
                    console.warn("Не удалось применить тему:", loadedTheme, e2);
                }
            });
        }
    }
    
    // === Функция для переключения темы ACE Editor ===
    function updateAceTheme() {
        var newBootstrapTheme = getBootstrapTheme();
        if (newBootstrapTheme !== currentBootstrapTheme) {
            currentBootstrapTheme = newBootstrapTheme;
            var newAceTheme = getAceTheme(newBootstrapTheme);
            applyTheme(newAceTheme);
        }
    }
    
    // === Кастомные стили для темной темы (если ACE тема недоступна) ===
    function applyDarkThemeStyles() {
        var editorEl = editor.container;
        if (!editorEl.classList.contains('ace-dark-custom')) {
            editorEl.classList.add('ace-dark-custom');
            var style = document.createElement('style');
            style.id = 'ace-dark-custom-styles';
            style.textContent = `
                .ace-dark-custom .ace_editor {
                    background-color: #212529 !important;
                    color: #f8f9fa !important;
                }
                .ace-dark-custom .ace_gutter {
                    background-color: #343a40 !important;
                    color: #adb5bd !important;
                }
                .ace-dark-custom .ace_gutter-active-line {
                    background-color: #495057 !important;
                }
                .ace-dark-custom .ace_cursor {
                    color: #f8f9fa !important;
                }
                .ace-dark-custom .ace_marker-layer .ace_selection {
                    background-color: #495057 !important;
                }
                .ace-dark-custom .ace_keyword {
                    color: #569cd6 !important;
                }
                .ace-dark-custom .ace_string {
                    color: #ce9178 !important;
                }
                .ace-dark-custom .ace_numeric {
                    color: #b5cea8 !important;
                }
                .ace-dark-custom .ace_comment {
                    color: #6a9955 !important;
                    font-style: italic;
                }
                .ace-dark-custom .ace_function {
                    color: #dcdcaa !important;
                }
            `;
            document.head.appendChild(style);
        }
    }
    
    function removeDarkThemeStyles() {
        var editorEl = editor.container;
        editorEl.classList.remove('ace-dark-custom');
        var style = document.getElementById('ace-dark-custom-styles');
        if (style) {
            style.remove();
        }
    }
    
    // === Отслеживание изменений темы Bootstrap ===
    var bodyTag = document.querySelector('[data-tag="body"]') || document.body;
    var themeObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
                updateAceTheme();
            }
        });
    });
    
    // Начинаем наблюдение за изменениями темы
    themeObserver.observe(bodyTag, {
        attributes: true,
        attributeFilter: ['data-bs-theme']
    });
    
    // Применяем тему при инициализации
    setTimeout(function() {
        var initialTheme = getAceTheme(currentBootstrapTheme);
        applyTheme(initialTheme);
    }, 100);

    if (formElement) {
        formElement.addEventListener('submit', function() {
            syncEditorValue();
        });
    }

    {% if syntax == 'python' %}
    // === 1. Загрузка символов из библиотек (функции, классы, методы) ===
    var librarySymbols = [];
    fetch('/api/utils/intelli-python')
        .then(response => response.json())
        .then(data => {
            librarySymbols = data.symbols || [];
            librarySymbols.forEach(item => librarySymbolsMap[item.qualified_name] = item);
            updateCompleter();
        })
        .catch(err => console.warn("IntelliSense load failed:", err));

    // === 2. Статические функции (ваш API) ===
    var staticApi = [
        { word: "setProperty", args: "(name, value)", doc: "Устанавливает свойство объекта." },
        { word: "callMethod", args: "(name, *args)", doc: "Вызывает метод объекта с переданными аргументами." },
        { word: "say", args: "(text)", doc: "Произносит переданный текст вслух." }
    ];

    var staticApiMap = {};
    staticApi.forEach(item => staticApiMap[item.word] = item);
    var librarySymbolsMap = {};
    
    var builtinFunctions = [
        "print", "len", "str", "int", "float", "bool", "list", "dict", "tuple", "set",
        "range", "enumerate", "zip", "map", "filter", "open", "input", "type",
        "isinstance", "hasattr", "getattr", "setattr", "dir"
    ];

    // === 3. Вспомогательная функция экранирования HTML ===
    function escapeHtml(text) {
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "<")
            .replace(/>/g, ">")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // === 4. Обновляемый completer с поддержкой многострочных доков ===
    function updateCompleter() {
        var completer = {
            getCompletions: function(editor, session, pos, prefix, callback) {
                if (prefix.length === 0) return callback(null, []);

                var completions = [];

                // Статические функции
                staticApi.forEach(function(item) {
                    var docEsc = escapeHtml(item.doc);
                    completions.push({
                        caption: item.word + item.args,
                        value: item.word,
                        meta: "osysHome",
                        docHTML: `
<b>${item.word}</b>${item.args}
<pre style="margin-top:4px; white-space:pre-wrap; font-family:system-ui, sans-serif; font-size:12px;">${docEsc}</pre>
                        `
                    });
                });

                // Символы из библиотек
                librarySymbols.forEach(function(sym) {
                    var displayName = sym.type === "method"
                        ? sym.qualified_name
                        : sym.name;
                    var meta = "lib:" + (sym.module ? sym.module.split('.').pop() : "user");
                    if (sym.type === "class") meta += " (class)";
                    if (sym.type === "method") meta += " (method)";
                    var docEsc = escapeHtml(sym.doc || "Без описания.");
                    var moduleInfo = sym.module ? `<small style="color:#888">${sym.module}</small>` : "";
                    completions.push({
                        caption: displayName,
                        value: sym.type === "method" ? sym.qualified_name : sym.name,
                        meta: meta,
                        docHTML: `
<b>${displayName}</b>${sym.signature}
<small>${moduleInfo}</small>
<pre style="margin-top:4px; white-space:pre-wrap; font-family:system-ui, sans-serif; font-size:12px;">${docEsc}</pre>
`
                    });
                });

                // Встроенные функции
                builtinFunctions.forEach(function(word) {
                    completions.push({
                        caption: word + "()",
                        value: word,
                        meta: "builtin",
                        docHTML: `
<b>${word}()</b>
<pre style="margin-top:4px; white-space:pre-wrap; font-family:system-ui, sans-serif; font-size:12px;">Встроенная функция Python.</pre>
                        `
                    });
                });

                callback(null, completions);
            }
        };
        editor.completers = [completer];
    }

    // Инициализация completer (пока без библиотек)
    updateCompleter();

    // === 5. Сниппеты ===
    var customSnippets = [
        { name: "print", tabTrigger: "pr", content: "print('${1:message}')", scope: "python" },
        { name: "def", tabTrigger: "def", content: "def ${1:name}(${2:args}):\n    ${3:pass}", scope: "python" },
        { name: "setProperty", tabTrigger: "setp", content: "setProperty('${1:name}', ${2:value})", scope: "python" },
        { name: "callMethod", tabTrigger: "callm", content: "callMethod('${1:method}', ${2:args})", scope: "python" },
        { name: "say", tabTrigger: "say", content: "say('${1:text}')", scope: "python" }
    ];

    var snippetManager = ace.require("ace/snippets").snippetManager;
    var modeId = "ace/mode/python";
    var snippetFile = snippetManager.files[modeId];
    if (!snippetFile) {
        snippetFile = snippetManager.files[modeId] = { snippets: [], scope: "python" };
    }
    customSnippets.forEach(snip => snippetFile.snippets.push(snip));
    snippetManager.register(snippetFile.snippets, snippetFile.scope);

    // === 6. Валидация синтаксиса ===
    var validateTimeout;
    var session = editor.getSession();

    function validateCode() {
        var code = editor.getValue();
        if (!code.trim()) {
            session.clearAnnotations();
            return;
        }

        fetch('/api/utils/validate-python', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(errors => {
            session.clearAnnotations();
            if (errors.length > 0) {
                session.setAnnotations(errors);
            }
        })
        .catch(err => console.warn("Validation failed:", err));
    }

    editor.on('change', function() {
        clearTimeout(validateTimeout);
        validateTimeout = setTimeout(validateCode, 600);
    });
    validateCode();
    
    bindButton(toolbarButtons.validate, function() {
        validateCode();
    });

    // === 7. Hover для статических функций ===
    var tooltipEl = null;
    var hoverTimeout = null;

    function createTooltip() {
        if (!tooltipEl) {
            tooltipEl = document.createElement("div");
            tooltipEl.classList.add("card");
            tooltipEl.style.cssText = `
                position: fixed;
                padding: 6px 10px;
                z-index: 1000000;
                white-space: nowrap;
            `;
            document.body.appendChild(tooltipEl);
        }
        return tooltipEl;
    }

    function showTooltip(x, y, html) {
        var tooltip = createTooltip();
        tooltip.innerHTML = html;
        tooltip.style.left = (x + 10) + "px";
        tooltip.style.top = (y + 10) + "px";
        tooltip.style.display = "block";
    }

    function hideTooltip() {
        if (tooltipEl) tooltipEl.style.display = "none";
    }

    var editorContainer = editor.container;
editorContainer.addEventListener("mousemove", function(e) {
    if (hoverTimeout) clearTimeout(hoverTimeout);

    // Получаем координаты относительно контейнера редактора
    const rect = editor.container.getBoundingClientRect();
    const x = e.clientX // - rect.left;
    const y = e.clientY //- rect.top;

    // Преобразуем экранную позицию в текстовую (row, column)
    const pos = editor.renderer.screenToTextCoordinates(x, y);

    // Получаем диапазон слова в этой позиции
    const session = editor.session;
    const range = session.getWordRange(pos.row, pos.column);
    const word = session.getTextRange(range);

    // --- Проверка: есть ли перед словом "self."? ---
    var line = session.getLine(pos.row);
    var wordStart = range.start.column;
    var wordEnd = range.end.column;

    // Ищем "self." непосредственно перед словом (с возможными пробелами)
    var prefix = line.substring(0, wordStart).trimEnd(); // всё до слова, без завершающих пробелов

    var hasSelfPrefix = false;
    if (prefix.endsWith('self.')) {
        hasSelfPrefix = true;
    }

    //console.log("x:",x," y:",y," Word:", word, "at", pos, hasSelfPrefix,librarySymbolsMap);
    if (word && hasSelfPrefix && librarySymbolsMap["ObjectManager."+word]) {
        var item = librarySymbolsMap["ObjectManager."+word];
        var html = "<b>" + escapeHtml(item.name) + "</b>" + escapeHtml(item.signature) + "<br>" + 
        '<pre style="margin-top:4px; white-space:pre-wrap; font-family:system-ui, sans-serif; font-size:12px;">'+item.doc+"</pre>";
        hoverTimeout = setTimeout(() => showTooltip(e.clientX, e.clientY, html), 300);
        return;
    }
    if (word && !hasSelfPrefix && librarySymbolsMap[word]) {
        var item = librarySymbolsMap[word];
        var html = "<b>" + escapeHtml(item.name) + "</b>" + escapeHtml(item.signature) + "<br>" + 
        '<pre style="margin-top:4px; white-space:pre-wrap; font-family:system-ui, sans-serif; font-size:12px;">'+item.doc+"</pre>";
        hoverTimeout = setTimeout(() => showTooltip(e.clientX, e.clientY, html), 300);
        return;
    }
    hideTooltip();
});

    editorContainer.addEventListener("mouseleave", hideTooltip);
    window.addEventListener("scroll", hideTooltip);
    {% endif %}

    // === Инициализация темы при загрузке ===
    // Небольшая задержка для гарантии загрузки всех тем
    setTimeout(function() {
        updateAceTheme();
    }, 150);
    
})();
</script>
{% endmacro %}